#!/usr/bin/env Rscript
# ==============================================================================
# vacant (inst/bin/vacant)
# CLI entry point for the VACANT package.
# Usage: vacant --matrix "..." --ped "..." --score "..." --output "..."
# ==============================================================================

suppressPackageStartupMessages({
  library(optparse)
  library(data.table)
})

# ---- 1. Define CLI Arguments ----
option.list <- list(
  make_option("--matrix",
              type = "character",
              help = "[Required] Path to gzipped XPAT 2.0 matrix file (.gz)."),
  make_option("--ped",
              type = "character",
              help = "[Required] Path to PED file (header: #fid iid pid mid sex aff ...)."),
  make_option("--score",
              type = "character",
              help = "[Required] Path to annotation score file (no header, cols 1-8 = metadata, col 9+ = scores)."),
  make_option("--output",
              type = "character",
              help = "[Required] Output CSV path. An .rds model file is also saved alongside."),
  make_option("--covariates",
              type    = "character",
              default = NULL,
              help    = "[Optional] Path to covariate/PCA file (no header, col 1 = IID)."),
  make_option("--score_cols",
              type    = "character",
              default = NULL,
              help    = "[Optional] Comma-separated score column names matching col 9+ of score file (e.g. CADD,aPC)."),
  make_option("--test",
              type    = "character",
              default = "multi",
              help    = "Statistical test: multi (default) or uni."),
  make_option("--weight",
              type    = "character",
              default = "score",
              help    = "ACAT weighting: score (default) or equal."),
  make_option("--maf",
              type    = "numeric",
              default = 0.01,
              help    = "MAF threshold for rare variant filtering (default: 0.01)."),
  make_option("--size_threshold",
              type    = "integer",
              default = 10L,
              help    = "Minimum cluster size for K-means (default: 10)."),
  make_option("--transform",
              type    = "character",
              default = "none",
              help    = "Score transformation: none (default), raw_squared, phred_to_chisq, log, sigmoid."),
  make_option("--gene_col",
              type    = "integer",
              default = 7L,
              help    = "Column index of gene name in matrix (default: 7)."),
  make_option("--meta_ncols",
              type    = "integer",
              default = 11L,
              help    = "Number of metadata columns before genotype string (default: 11)."),
  make_option("--n_cores",
              type    = "integer",
              default = 1L,
              help    = "CPU cores for parallel gene processing (default: 1). Set > 1 for chromosome-level matrices.")
)

parser <- OptionParser(
  usage       = "vacant [options]",
  description = paste(
    "\nVACANT: Variant Annotation Clustering AssociatioN Test",
    "Rare variant association testing using multi-dimensional annotation scores.",
    sep = "\n"
  ),
  option_list = option.list
)

args <- parse_args(parser)

# ---- 2. Validate Required Arguments ----
required <- c("matrix", "ped", "score", "output")
missing.args <- required[sapply(required, function(x) is.null(args[[x]]))]
if (length(missing.args) > 0) {
  cat("Error: Missing required argument(s):", paste0("--", missing.args, collapse = ", "), "\n\n")
  print_help(parser)
  quit(save = "no", status = 1)
}

# ---- 3. Load VACANT Package ----
if (!requireNamespace("VACANT", quietly = TRUE)) {
  stop(paste(
    "The VACANT package is not installed.",
    "Install with: remotes::install_github('ShuHsienCho/VACANT')"
  ))
}
library(VACANT, character.only = TRUE)

# ---- 4. Parse Score Columns ----
score.cols.vec <- NULL
if (!is.null(args$score_cols) && nzchar(args$score_cols)) {
  score.cols.vec <- trimws(unlist(strsplit(args$score_cols, ",")))
}

# ---- 5. Run VACANT ----
message(sprintf(
  "[vacant] test=%s | transform=%s | maf=%.4f | size_threshold=%d | n_cores=%d",
  args$test, args$transform, args$maf, args$size_threshold, args$n_cores
))

result.dt <- tryCatch(
  vacant(
    matrix.file      = args$matrix,
    ped.file         = args$ped,
    score.file       = args$score,
    cov.file         = args$covariates,
    score.cols       = score.cols.vec,
    maf.threshold    = args$maf,
    size.threshold   = args$size_threshold,
    transform.method = args$transform,
    test             = args$test,
    acat.weight      = args$weight,
    gene.col         = args$gene_col,
    meta.ncols       = args$meta_ncols,
    n.cores          = args$n_cores
  ),
  error = function(e) {
    stop(sprintf("[vacant] Error: %s", e$message))
  }
)

# ---- 6. Save Outputs ----
if (is.null(result.dt) || nrow(result.dt) == 0L) {
  message("[vacant] No results returned. No output saved.")
  quit(save = "no", status = 0)
}

# Save CSV (drop hidden .model column)
csv.dt <- result.dt[, !colnames(result.dt) %in% ".model", with = FALSE]
data.table::fwrite(csv.dt, file = args$output)
message(sprintf("[vacant] Results saved: %s", args$output))

# Save RDS (one per gene, contains Pareto model for predict_vacant_cluster())
if (".model" %in% colnames(result.dt)) {
  for (i in seq_len(nrow(result.dt))) {
    gene.name <- result.dt[["gene"]][i]
    rds.path  <- sub("\\.csv$", sprintf("_%s.rds", gene.name), args$output)
    if (rds.path == args$output) {
      rds.path <- sprintf("%s_%s.rds", args$output, gene.name)
    }
    saveRDS(
      list(
        results = as.list(csv.dt[i, ]),
        model   = result.dt[[".model"]][[i]],
        gene    = gene.name
      ),
      file = rds.path
    )
    message(sprintf("[vacant] Model saved:   %s", rds.path))
  }
}

message("[vacant] Done.")
