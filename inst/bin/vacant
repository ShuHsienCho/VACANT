#!/usr/bin/env Rscript

# 1. Check Package
if (!requireNamespace("VACANT", quietly = TRUE)) {
  stop("Error: 'VACANT' package not installed.", call. = FALSE)
}

suppressPackageStartupMessages({
  library(optparse)
  library(data.table)
  library(VACANT)
})

# 2. Define Arguments
option_list <- list(
  # --- Common Inputs ---
  make_option(c("-i", "--input"), type="character", help="[Required] Input file (CSV/TXT). For Analysis: must contain Genotypes & Scores. For Prediction: contains Scores.", metavar="FILE"),
  make_option(c("--score_cols"), type="character", help="[Required] Comma-separated score column names (e.g., 'CADD,REVEL').", metavar="STR"),
  make_option(c("-o", "--output"), type="character", help="[Required] Output filename.", metavar="FILE"),
  
  # --- Analysis Mode Arguments ---
  make_option(c("--geno_col"), type="character", default="genotype", help="[Analysis] Genotype string column name [default: genotype].", metavar="STR"),
  make_option(c("--pheno"), type="character", help="[Analysis] Phenotype file path.", metavar="FILE"),
  make_option(c("--cov"), type="character", default=NULL, help="[Analysis] Covariate file path [Optional].", metavar="FILE"),
  make_option(c("--test"), type="character", default="multi", help="[Analysis] Test type: 'multi' or 'uni'."),
  make_option(c("--weight"), type="character", default="score", help="[Analysis] Weight: 'score' or 'equal'."),
  make_option(c("--size_threshold"), type="integer", default=10, help="[Analysis] Min cluster size [default: 10]."),
  
  # --- Prediction Mode Arguments ---
  make_option(c("--model"), type="character", default=NULL, help="[Prediction Only] Path to an existing .rds model file. If provided, runs PREDICTION mode.", metavar="FILE")
)

parser <- OptionParser(usage = "Usage:\n  Analyze: vacant -i data.csv --pheno pheno.ped -o result\n  Predict: vacant -i new_vars.csv --model result.rds -o pred.csv", option_list=option_list)
args <- parse_args(parser)

# 3. Main Logic
if (is.null(args$input) || is.null(args$output) || is.null(args$score_cols)) {
  print_help(parser)
  stop("Error: Missing basic arguments (-i, -o, --score_cols).", call.=FALSE)
}

# Helper to read scores
read_scores <- function(file, cols_str) {
  df <- fread(file, header = TRUE, data.table = FALSE)
  cols <- trimws(strsplit(cols_str, ",")[[1]])
  missing <- setdiff(cols, colnames(df))
  if(length(missing) > 0) stop(paste("Error: Missing score columns:", paste(missing, collapse=", ")))
  return(list(mat = as.matrix(df[, cols, drop=FALSE]), df = df)) # Return raw df to keep IDs if needed
}

# ==========================================
# MODE 1: PREDICTION (If --model is present)
# ==========================================
if (!is.null(args$model)) {
  message(sprintf(">> [VACANT] Mode: PREDICTION"))
  message(sprintf("   Loading model: %s", args$model))
  
  if (!file.exists(args$model)) stop("Model file not found.")
  
  # 1. Load Model
  model_obj <- readRDS(args$model)
  # Handle both full object (list with $model) or just the model part
  model_core <- if("model" %in% names(model_obj)) model_obj$model else model_obj
  
  # 2. Read New Scores
  message(sprintf("   Reading new variants: %s", args$input))
  input_data <- read_scores(args$input, args$score_cols)
  score_mat <- input_data$mat
  
  # 3. Run Prediction
  message("   Predicting risk clusters...")
  # Note: The function handles log-transform automatically based on model params
  pred_clusters <- VACANT::predict_vacant_cluster(model_core, score_mat)
  
  # 4. Save Output
  out_df <- input_data$df # Start with original input
  out_df$VACANT_Cluster <- pred_clusters
  
  fwrite(out_df, args$output)
  message(sprintf(">> [Success] Predictions saved to: %s", args$output))
  
  quit(save = "no", status = 0)
}

# ==========================================
# MODE 2: ANALYSIS (Standard VACANT Pipeline)
# ==========================================
message(sprintf(">> [VACANT] Mode: ANALYSIS (Training & Testing)"))

if (is.null(args$pheno)) stop("Error: Analysis mode requires --pheno.")

# --- A. Read Inputs ---
message("   Reading inputs...")

# 1. Scores & Genotypes (From same file)
input_data <- read_scores(args$input, args$score_cols)
score_mat <- input_data$mat
raw_df <- input_data$df

if (!args$geno_col %in% colnames(raw_df)) stop(sprintf("Genotype column '%s' not found.", args$geno_col))
geno_vec <- as.character(raw_df[[args$geno_col]])

# 2. Phenotypes
pheno_raw <- fread(args$pheno, header = TRUE, data.table = FALSE)
# Heuristic for column name
p_col <- colnames(pheno_raw)[match(c("phenotype", "aff"), tolower(colnames(pheno_raw)))[1]]
if(is.na(p_col)) p_col <- colnames(pheno_raw)[min(6, ncol(pheno_raw))] # Fallback
pheno_vec <- pheno_raw[[p_col]]
if(max(pheno_vec, na.rm=TRUE) > 1) pheno_vec <- pheno_vec - 1
pheno_df <- data.frame(phenotype = pheno_vec)

# 3. Covariates
cov_df <- NULL
if (!is.null(args$cov)) {
  cov_raw <- fread(args$cov, header = TRUE, data.table = FALSE)
  cov_df <- if(is.numeric(cov_raw[[1]])) cov_raw else cov_raw[,-1, drop=FALSE]
}

# --- B. Validation ---
if (nrow(score_mat) != nrow(pheno_df)) stop("Sample size mismatch (Scores vs Pheno).")

# --- C. Run ---
message(sprintf("   Running VACANT (%s)...", args$test))
res_obj <- VACANT::vacant(
  geno.maf = geno_vec,
  score.vector = score_mat,
  phenotype = pheno_df,
  covariates = cov_df,
  test = args$test,
  acat.weight = args$weight,
  size.threshold = args$size_threshold
)

# --- D. Output ---
if (!is.null(res_obj)) {
  # Save Model (RDS)
  rds_path <- sub("\\.csv$", ".rds", args$output)
  if(rds_path == args$output) rds_path <- paste0(args$output, ".rds")
  saveRDS(res_obj, rds_path)
  message(sprintf("   Model saved: %s", rds_path))
  
  # Save Stats (CSV)
  out_df <- as.data.frame(t(res_obj$results))
  fwrite(out_df, args$output)
  message(sprintf(">> [Success] Statistics saved: %s", args$output))
} else {
  message(">> Analysis returned NULL.")
}