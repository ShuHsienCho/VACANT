# VACANT: Variant Annotation Clustering AssociatioN Test


**VACANT** is a robust R framework for rare variant association testing. It leverages **multi-dimensional annotation scores** to cluster variants into risk tiers using a conservative **Pareto Staircase** approach, followed by an aggregated association test (ACAT) or a joint multivariate Firth regression.

It is designed to handle highly skewed genomic scores (e.g., CADD, SpliceAI) via automatic log-transformation and provides a portable prediction model for clinical risk stratification.

---

##  Installation & Setup

VACANT can be used as a **Command Line Tool** (like SAIGE/PLINK) or as a standard **R Library**.

### 1. Install the R Package

First, install the package dependencies and VACANT itself in R.

```r
# In R console
install.packages(c("devtools", "optparse", "data.table", "stringi", "logistf", "mclust", "dplyr"))

# Install VACANT from source (assuming you are in the VACANT directory)
devtools::install_local(".") 
# Or from GitHub: 
# devtools::install_github("YourUsername/VACANT")

```

### 2. Set up the Command Line Tool (CLI)

To run `vacant` directly from your terminal, copy the wrapper script to your system path.

```bash
# 1. Navigate to the binary folder in the repo
cd inst/bin/

# 2. Make executable
chmod +x vacant

# 3. Copy to system bin (Requires sudo)
sudo cp vacant /usr/local/bin/

# --- Alternative (No sudo) ---
# mkdir -p ~/bin && cp vacant ~/bin/
# export PATH=$PATH:~/bin

```

---

##  CLI Usage: Mode 1 - Analysis (Training)

The default mode. Performs clustering, runs statistical tests, and saves the trained model.

### Command Example

```bash
vacant \
  --geno data/genotypes.txt \
  --score data/scores.csv \
  --pheno data/phenotypes.ped \
  --cov data/covariates.txt \
  --score_cols "CADD,REVEL" \
  --test multi \
  --output results/TP53_result

```

### Arguments

| Argument | Description |
| --- | --- |
| `--geno` | **[Required]** Path to file containing Genotype Strings (e.g., "00100..."). |
| `--score` | **[Required]** Path to file containing Annotation Scores. |
| `--pheno` | **[Required]** Path to file containing Phenotypes. |
| `--cov` | **[Optional]** Path to file containing Covariates (e.g., PCA). |
| `--score_cols` | **[Required]** Comma-separated list of score columns to use (e.g., "CADD,REVEL"). |
| `--output` | **[Required]** Output prefix. Generates `.csv` (stats) and `.rds` (model). |
| `--test` | `multi` (Joint model, returns Betas) or `uni` (ACAT P-value only). |
| `--weight` | `score` (Risk-weighted, default) or `equal`. |
| `--size_threshold` | Minimum cluster size (default: 10). |

---

## ðŸ”® CLI Usage: Mode 2 - Prediction

Use a previously trained model (`.rds`) to predict risk tiers for **new variants**.

### Command Example

```bash
vacant \
  --input new_variants.csv \
  --model results/TP53_result.rds \
  --score_cols "CADD,REVEL" \
  --output results/predictions.csv

```

### Arguments

| Argument | Description |
| --- | --- |
| `--model` | **[Required]** Path to the `.rds` file generated by the Analysis mode. |
| `--input` | **[Required]** Path to CSV containing **raw scores** for new variants. |
| `--score_cols` | **[Required]** Score columns to use (Must match the training model). |
| `--output` | Output filename for predictions. |

> **Note**: The CLI automatically handles the Log-transformation and Shift using the parameters stored in the model. You do not need to pre-process the scores.

---

## ðŸ“„ Input File Formats

**All input files for Analysis Mode must be row-aligned (same number of samples, same order).**

1. **Genotype File** (`--geno`): Single column of strings (Allele counts).
```text
genotype
00100100...
00000000...

```


2. **Score File** (`--score`): Matrix of numeric scores.
```text
CADD,REVEL
25.4,0.8
10.1,0.2

```


3. **Phenotype File** (`--pheno`): Matrix/Vector with a `phenotype` or `aff` column (0/1).
4. **Covariate File** (`--cov`): Matrix of numeric covariates.

---

## ðŸ’» Usage: R Library

If you prefer working interactively in R Studio:

### 1. Analysis (`vacant`)

```r
library(VACANT)

# 1. Load Data (User responsibility)
# Ensure all vectors/matrices are row-aligned
my_genos <- c("00100...", "00010...", "00000...") 
my_scores <- matrix(c(20, 0.5, 10, 0.2, 0, 0), ncol=2)
my_pheno <- data.frame(phenotype = c(1, 0, 0))
my_cov   <- data.frame(PC1 = c(0.1, -0.2, 0.5))

# 2. Run Analysis
result_obj <- vacant(
  geno.maf     = my_genos,
  score.vector = my_scores,
  phenotype    = my_pheno,
  covariates   = my_cov,
  test         = "multi",
  acat.weight  = "score"
)

# 3. Explore Results
print(result_obj$results) # View P-values and Betas

```

### 2. Clinical Prediction (`predict_vacant_cluster`)

```r
# Load trained model (from CLI output)
model_obj <- readRDS("results/TP53_result.rds")

# New variants (Raw scores)
new_variants <- data.frame(
  CADD = c(30, 5), 
  REVEL = c(0.9, 0.1)
)

# Predict (Returns integer cluster IDs: 1=Benign, K=High Risk)
risk_groups <- predict_vacant_cluster(model_obj$model, new_variants)

```

---

## ðŸ§  Methodology

1. **Log-Shift Transformation**: Handles highly right-skewed genomic scores by automatically detecting negative values, shifting them, and applying `log1p`.
2. **Pareto Staircase Clustering**:
* Scores are standardized (Z-score) and clustered using GMM-initialized K-means.
* Clusters are sorted by **Algebraic Sum** (Cluster 1 = Lowest Risk).
* **Conservative Boundary**: A variant is assigned to a high-risk cluster only if it dominates the cluster's **Pareto Anchors** in **ALL** dimensions.


3. **Statistical Testing**:
* **Firth Regression**: Uses penalized likelihood to handle rare variants and unbalanced case/control ratios.
* **Fallback Mechanism**: If the full model fails (Singular Fisher Information), it automatically retries without covariates to salvage a valid P-value.



---

## ðŸ“‚ File Structure

```text
R/
â”œâ”€â”€ vacant.R                  # Main analysis engine
â”œâ”€â”€ cluster_score.R           # Log-transform & Pareto Clustering logic
â”œâ”€â”€ analyze_set.R             # Statistical tests (Firth / ACAT)
â”œâ”€â”€ predict_vacant_cluster.R  # Clinical prediction module
â”œâ”€â”€ vacant_helpers.R          # Utilities (ACAT, safe_logistf, GMM-Kmeans)
â””â”€â”€ find_pareto_anchors.R     # Optimization algorithm

inst/bin/
â””â”€â”€ vacant                    # CLI Executable Script